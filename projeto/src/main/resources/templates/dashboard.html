<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../static/css/pages.css">
    <link rel="stylesheet"
        href="./../static/images/assets/fontawesome-free-6.5.2-web/fontawesome-free-6.5.2-web/css/all.css">


    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="icon" href="../static/images/WhatsApp_Image_2024-07-20_at_15.43.02-removebg-preview.png">
    <title>Nossa Arena</title>
</head>
<style>
    #searchCPF {
        width: 100%;
        max-width: 300px;
        padding: 10px 40px 10px 40px;
        /* Espaço para o ícone à esquerda */
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        justify-content: center;
    }

    #searchInput::placeholder {
        color: #aaa;
    }

    .search-container i {
        position: fixed;
        right: 91.5%;
        top: 31.6%;
        transform: translateY(30%);
        /* Ajuste para centralização vertical */
        font-size: 1.4rem;
        color: #00690A;
    }
</style>

<body class="page-dashboard">

    <body>
        <nav id="sidebar">
            <div id="sidebar_content">
                <div id="user">
                    <img src="../static/images/WhatsApp_Image_2024-07-20_at_15.43.02-removebg-preview.png"
                        id="user_avatar" alt="Avatar">

                    <p id="user_infos">
                        <span class="item-description">
                            Nossa Arena
                        </span>
                        <span class="item-description">
                            Software
                        </span>
                    </p>
                </div>

                <ul id="side_items">
                    <li class="side-item">
                        <a href="home.html">
                            <i class="fa-solid fa-house"></i>
                            <span class="item-description">Inicio</span>
                        </a>
                    </li>

                    </li>
                    <li class="side-item active">
                        <a href="dashboard.html">
                            <i class="fa-solid fa-chart-line"></i>
                            <span class="item-description">Dashboard</span>
                        </a>
                    </li>
                    <li class="side-item">
                        <a href="horario.html">
                            <i class="fa-solid fa-clock"></i>
                            <span class="item-description">Horarios</span>
                        </a>
                    <li class="side-item">
                        <a href="calendar.html">
                            <i class="fa-solid fa-calendar-days"></i>
                            <span class="item-description">Calendário</span>
                        </a>

                    <li class="side-item">
                        <a href="cadastro.html">
                            <i class="fa-solid fa-address-card"></i>
                            <span class="item-description">Cadastro</span>
                        </a>
                    </li>
                    <li class="side-item">
                        <a href="jogadores.html">
                            <i class="fa-solid fa-futbol"></i>
                            <span class="item-description">Jogadores</span>
                        </a>
                    </li>



                    <button id="open_btn">
                        <i id="open_btn_icon" class="fa-solid fa-chevron-right"></i>
                    </button>
            </div>

            <div id="confirmPaymentPopup" class="popup" style="display: none;">
                <img src="../static/images/Imagem1.png">

                <h2>Tem certeza que deseja marcar este pagamento como concluído?</h2>
                <div class="popup-buttons">
                    <button id="confirmPaymentButton">Sim</button>
                    <button id="cancelPaymentButton">Cancelar</button>
                </div>
            </div>


            <div id="logout">
                <a href="index.html">
                    <button id="logout_btn">
                        <i class="fa-solid fa-right-from-bracket"></i>
                </a>
                <span class="item-description">
                    Logout
                </span>

                </button>
            </div>
        </nav>

        <div class="popup sair-popup" id="confirmExitPopup" style="display: none;">
            <aside>
                <img src="../static/images/WhatsApp_Image_2024-07-20_at_15.43.02-removebg-preview.png" alt=""
                    class="logo-img">

            </aside>
            <h2>Deseja sair?</h2>

            <div class="popup-buttons">
                <button id="confirmExit">Sim</button>
                <button id="cancelExit">Cancelar</button>
            </div>
        </div>
        <main>

            <header>
                <h1>Nossa <span>Arena</span></h1>
                <div class="contatos">
                    <a href="https://www.instagram.com/nossarena_/"> <i class="fa-brands fa-instagram"></i></a>

                    <p>|</p>

                    <a
                        href="https://api.whatsapp.com/send/?phone=5531999575269&text=Oi!+Vim+pelo+Instagram+e+queria+informa%C3%A7%C3%B5es+sobre+a+NossArena!&type=phone_number&app_absent=0">
                        <i class="fa-brands fa-whatsapp"></i></a>

                    <p>|</p>
                    <a href="#"><i class="fa-solid fa-envelope"></i></a>

                    <p>|</p>


                    <a href="#" id="phone-icon">
                        <i class="fa-solid fa-phone"></i>
                    </a>

                    <p>|</p>
                    <a
                        href="https://www.google.com/maps/place/NossArena+Uruc%C3%A2nia/@-20.3589574,-42.7521078,17z/data=!3m1!4b1!4m6!3m5!1s0xa4b9c6f8a90ad7:0x7833dfc79ca6d117!8m2!3d-20.3589574!4d-42.7521078!16s%2Fg%2F11vjg0w6hq?entry=ttu">
                        <i class="fa-solid fa-location-dot"></i></a>
                    <div id="notification" style="display: none;">Número de telefone copiado!</div>
                </div>

                <img src="../static/images/WhatsApp_Image_2024-07-20_at_15.43.02-removebg-preview.png"
                    id="user_avatar_secondary" alt="Avatar">
            </header>
            <div id="loading-screen">
                <div class="loader-container">
                    <img src="../static/images/WhatsApp_Image_2024-07-20_at_15.43.02-removebg-preview.png"
                        alt="Loading Image" class="loading-image">
                    <div class="loader"></div>
                </div>
            </div>
            <div class="container">
                <div class="main-body">
                    <div class="promo_card">
                        <h1>Dashboards</h1>
                        <p>Acesso a do documentação explicativa.</p>
                        <button class="btn-download">
                            <span class="btn-text">Baixar</span>
                            <i class="fa fa-download"> </i>
                        </button>

                    </div>
                    <div class="search-container">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="searchCPF" placeholder="Pesquisar por CPF ou Nome">
                    </div>
                    <div class="history_lists">

                        <script>

                        </script>

                        <div class="table-container">
                            <h4>Histórico de Partidas</h4>

                            <div class="filters">
                                <button id="filter-day" onclick="filterByDay()">Dia</button>
                                <button id="filter-week" onclick="filterByWeek()">Semana</button>
                                <button id="filter-month" onclick="filterByMonth()">Mês</button>
                                <button id="filter-year" onclick="filterByYear()">Ano</button>
                            </div>

                            <div class="button-container">
                                <button id="refresh-button" class="btn-refresh">
                                    <i class="fa-solid fa-arrows-rotate"></i>
                                </button>
                            </div>

                            <div class="scrollable-table">
                                <table id="partidas-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>CPF Usuário</th>
                                            <th>Data da Partida</th>
                                            <th>Horário</th>
                                            <th>Nome</th>
                                            <th>Preço Cobrado</th>
                                            <th>Status do Pagamento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dados da tabela -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="sidebar">
                            <h2>Receita:</h2>
                            <div class="balance">
                                <i class="fas fa-dollar icon"></i>
                                <div class="info">
                                    <h5>Diária:</h5>
                                    <span class="daily">0.00</span>
                                </div>
                            </div>
                            <div class="balance">
                                <i class="fas fa-dollar icon"></i>
                                <div class="info">
                                    <h5>Semanal:</h5>
                                    <span class="weekly">0.00</span>
                                </div>
                            </div>
                            <div class="balance">
                                <i class="fas fa-dollar icon"></i>
                                <div class="info">
                                    <h5>Mensal:</h5>
                                    <span class="monthly">0.00</span>
                                </div>
                            </div>
                            <div class="balance">
                                <i class="fas fa-dollar icon"></i>
                                <div class="info">
                                    <h5>Anual:</h5>
                                    <span class="annual">0.00</span>
                                </div>
                            </div>

                        </div>
        </main>
        <script>

            let allData = []; // Armazena todos os dados recebidos


            document.addEventListener('DOMContentLoaded', function () {
                fetch('http://localhost:8080/partidas/com-nomes')
                    .then(response => response.json())
                    .then(data => {
                        allData = data; // Dados agora incluem o nome do usuário
                        populateTable(allData);
                    })
                    .catch(error => {
                        console.error('Erro ao carregar os dados:', error);
                    });
            });

            function formatarData(dataString) {
                const partes = dataString.split('-'); // Supondo que a data está no formato "YYYY-MM-DD"
                return `${partes[2]}/${partes[1]}/${partes[0]}`; // Retorna no formato "DD/MM/YYYY"
            }

            function populateTable(data) {
                const tableBody = document.querySelector('#partidas-table tbody');
                tableBody.innerHTML = ''; // Limpa o conteúdo atual do corpo da tabela

                // Ordena os dados em ordem decrescente com base no ID
                const sortedData = data.sort((a, b) => b.id - a.id);

                sortedData.forEach(partida => {
                    const statusPagamento = partida.statusPagamento ? 'Pago' : 'Pendente';
                    const statusClass = statusPagamento === 'Pendente' ? 'status-pendente' : 'status-pago';

                    // Criação da linha da tabela
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>${partida.id}</td>
            <td>${partida.cpfUser || 'Não definido'}</td>
            <td>${formatarData(partida.dataPartida)}</td>
            <td>${partida.horario}</td>
            <td>${partida.nomeUsuario || 'Nome não disponível'}</td> <!-- Nome do usuário -->
            <td>R$ ${partida.precoCobrado ? partida.precoCobrado.toFixed(2) : '0.00'}</td>
            <td class="${statusClass}">
                ${statusPagamento}
                ${statusPagamento === 'Pendente' ? createPaymentButton(partida.id) : ''}
            </td>
        `;
                    tableBody.appendChild(row);
                });
            }


            // Função para criar o botão de pagamento
            function createPaymentButton(id) {
                return `
        <button class="btn-pagar" onclick="marcarComoPago(${id})">
            Marcar como pago
        </button>
    `;
            }

            function obterDataLocal(offsetDias = 0) {
                const hoje = new Date();
                hoje.setDate(hoje.getDate() + offsetDias); // Adiciona/subtrai dias
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0'); // Meses começam em 0
                const dia = String(hoje.getDate()).padStart(2, '0');
                return `${ano}-${mes}-${dia}`; // Retorna no formato 'YYYY-MM-DD'
            }


            // Função para marcar como pago (apenas exemplo, precisa integrar com backend)
            function marcarComoPago(id) {
                alert(`Partida com ID ${id} foi marcada como paga!`);
                // Aqui você deve adicionar a lógica para atualizar o status no backend
                // e recarregar a tabela para refletir a mudança de status.
            } fetch('http://localhost:8080/partidas')
                .then(response => response.json())
                .then(partidas => {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0); // Zera a hora para garantir comparação correta

                    const diaAtual = hoje.getDate();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    const diaSemana = hoje.getDay(); // 0 para Domingo, 6 para Sábado

                    // Função de filtro para o dia
                    const filtrarPorDia = (partida) => {
                        const hoje = obterDataLocal(); // Usa a função para obter a data local
                        const dataPartida = partida.dataPartida.split('T')[0]; // Extrai apenas a data
                        return dataPartida === hoje;
                    };


                    // Função de filtro para a semana
                    const filtrarPorSemana = (partida) => {
                        const hoje = new Date();
                        const diaSemana = hoje.getDay(); // 0 para Domingo, 6 para Sábado

                        const startOfWeek = new Date(hoje);
                        startOfWeek.setDate(hoje.getDate() - diaSemana);
                        startOfWeek.setHours(0, 0, 0, 0);

                        const endOfWeek = new Date(hoje);
                        endOfWeek.setDate(hoje.getDate() + (6 - diaSemana));
                        endOfWeek.setHours(23, 59, 59, 999);

                        const dataPartida = new Date(partida.dataPartida);
                        return dataPartida >= startOfWeek && dataPartida <= endOfWeek;
                    };



                    const filtrarPorMes = (partida) => {
                        const hoje = new Date();
                        const startOfMonth = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                        const endOfMonth = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

                        const dataPartida = new Date(partida.dataPartida);
                        return dataPartida >= startOfMonth && dataPartida <= endOfMonth;
                    };


                    const filtrarPorAno = (partida) => {
                        const hoje = new Date();
                        const startOfYear = new Date(hoje.getFullYear(), 0, 1);
                        const endOfYear = new Date(hoje.getFullYear(), 11, 31);

                        const dataPartida = new Date(partida.dataPartida);
                        return dataPartida >= startOfYear && dataPartida <= endOfYear;
                    };



                    // Função para calcular os ganhos (considerando apenas partidas pagas)
                    const calcularGanhos = (filtro) => {
                        return partidas.filter(partida => partida.statusPagamento === true) // Só as partidas pagas
                            .filter(filtro) // Aplica o filtro diário, semanal, mensal ou anual
                            .reduce((total, partida) => total + (partida.precoCobrado || 0), 0); // Soma o preço cobrado de cada partida
                    };


                    // Cálculos baseados nos filtros
                    const ganhosDiarios = calcularGanhos(filtrarPorDia);
                    const ganhosSemanais = calcularGanhos(filtrarPorSemana);
                    const ganhosMensais = calcularGanhos(filtrarPorMes);
                    const ganhosAnuais = calcularGanhos(filtrarPorAno);

                    // Inserir valores no HTML
                    document.querySelector('.daily').textContent = ganhosDiarios.toFixed(2);
                    document.querySelector('.weekly').textContent = ganhosSemanais.toFixed(2);
                    document.querySelector('.monthly').textContent = ganhosMensais.toFixed(2);
                    document.querySelector('.annual').textContent = ganhosAnuais.toFixed(2);

                })
                .catch(error => console.error('Erro ao buscar os dados:', error));

            function filterByDay() {
                applyFilter(() => {
                    const today = obterDataLocal(); // Usa a data local no formato 'YYYY-MM-DD'
                    const filteredData = allData.filter(partida => partida.dataPartida.split('T')[0] === today); // Compara somente a data
                    populateTable(filteredData);
                }, 'filter-day');
            }


            function filterByWeek() {
                applyFilter(() => {
                    const today = new Date();
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay()); // Calcula o início da semana
                    startOfWeek.setHours(0, 0, 0, 0); // Zera as horas

                    const endOfWeek = new Date(today);
                    endOfWeek.setDate(today.getDate() + (6 - today.getDay())); // Calcula o final da semana
                    endOfWeek.setHours(23, 59, 59, 999); // Último segundo do dia

                    const filteredData = allData.filter(partida => {
                        const partidaDate = new Date(partida.dataPartida);
                        return partidaDate >= startOfWeek && partidaDate <= endOfWeek; // Verifica se a data da partida está dentro da semana
                    });

                    populateTable(filteredData);
                }, 'filter-week');
            }


            function filterByMonth() {
                applyFilter(() => {
                    const today = new Date();
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1); // Primeiro dia do mês
                    startOfMonth.setHours(0, 0, 0, 0);

                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0); // Último dia do mês
                    endOfMonth.setHours(23, 59, 59, 999);

                    const filteredData = allData.filter(partida => {
                        const partidaDate = new Date(partida.dataPartida);
                        return partidaDate >= startOfMonth && partidaDate <= endOfMonth; // Verifica se a data está dentro do mês
                    });

                    populateTable(filteredData);
                }, 'filter-month');
            }


            function filterByYear() {
                applyFilter(() => {
                    const today = new Date();
                    const startOfYear = new Date(today.getFullYear(), 0, 1); // Primeiro dia do ano
                    startOfYear.setHours(0, 0, 0, 0);

                    const endOfYear = new Date(today.getFullYear(), 11, 31); // Último dia do ano
                    endOfYear.setHours(23, 59, 59, 999);

                    const filteredData = allData.filter(partida => {
                        const partidaDate = new Date(partida.dataPartida);
                        return partidaDate >= startOfYear && partidaDate <= endOfYear; // Verifica se a data está dentro do ano
                    });

                    populateTable(filteredData);
                }, 'filter-year');
            }


            // Função para remover a classe 'active' de todos os botões
            function removeActiveClass() {
                const filterButtons = document.querySelectorAll('.filters button');
                filterButtons.forEach(button => {
                    button.classList.remove('active');
                });
            }

            // Função para aplicar o filtro e ativar o botão
            function applyFilter(filterFunction, buttonId) {
                removeActiveClass(); // Remove a classe 'active' de todos os botões
                document.getElementById(buttonId).classList.add('active'); // Adiciona a classe 'active' ao botão clicado
                filterFunction(); // Aplica o filtro
            }


        </script>
        <script src="../static/js/refresh.js"></script>
        <script src="../static/js/scriptpages.js"></script>
        <script>
            let selectedPaymentId = null;

            // Função para exibir o pop-up de confirmação de pagamento
            function marcarComoPago(id) {
                selectedPaymentId = id; // Armazena o ID do pagamento selecionado
                document.getElementById('confirmPaymentPopup').style.display = 'block'; // Mostra o pop-up de confirmação
            }

            // Evento para confirmar o pagamento
            document.getElementById('confirmPaymentButton').addEventListener('click', function () {
                if (selectedPaymentId) {
                    // Atualiza o status de pagamento no backend
                    fetch(`http://localhost:8080/partidas/${selectedPaymentId}/marcar-pago`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro ao atualizar o status de pagamento.');
                            }
                            // Atualiza os dados e repopula a tabela
                            return fetch('http://localhost:8080/partidas/com-nomes');
                        })
                        .then(response => response.json())
                        .then(data => {
                            allData = data; // Atualiza os dados globais
                            populateTable(allData); // Repopula a tabela
                            document.getElementById('confirmPaymentPopup').style.display = 'none'; // Esconde o pop-up
                            selectedPaymentId = null; // Limpa o ID selecionado
                        })
                        .catch(error => {
                            console.error('Erro ao marcar como pago:', error);
                        });
                }
            });

            // Evento para cancelar a confirmação
            document.getElementById('cancelPaymentButton').addEventListener('click', function () {
                document.getElementById('confirmPaymentPopup').style.display = 'none'; // Esconde o pop-up
                selectedPaymentId = null; // Limpa o ID selecionado
            });

            // Função para filtrar a tabela com base no CPF ou Nome
            function filterTableByCPFOrName(searchTerm) {
                const rows = document.querySelectorAll('#partidas-table tbody tr');
                rows.forEach(row => {
                    const cpfCell = row.cells[1]?.textContent.trim().toLowerCase(); // Coluna CPF
                    const nameCell = row.cells[4]?.textContent.trim().toLowerCase(); // Coluna Nome

                    if ((cpfCell && cpfCell.includes(searchTerm)) || (nameCell && nameCell.includes(searchTerm))) {
                        row.style.display = ''; // Mostra a linha
                    } else {
                        row.style.display = 'none'; // Esconde a linha
                    }
                });
            }

            // Event listener para o campo de busca
            const searchInput = document.querySelector('#searchCPF'); // ID do campo de busca
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.trim().toLowerCase(); // Remove espaços extras e converte para minúsculas
                    filterTableByCPFOrName(searchTerm);
                });
            } else {
                console.error('Campo de busca não encontrado.');
            }

        </script>
    </body>

</html>